rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() { return request.auth != null; }
    function isOwner(uid) { return signedIn() && request.auth.uid == uid; }

    match /users/{uid} {
      allow read: if isOwner(uid);
      allow create: if isOwner(uid);
      allow update, delete: if false; // userDoc zmienia backend (limit)
    }

    match /jobs/{jobId} {
      allow read: if signedIn() && resource.data.userId == request.auth.uid;

      // klient może tylko UTWORZYĆ joba i tylko dla siebie
      allow create: if signedIn()
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.status == "queued"
        && request.resource.data.type == "GENERATE_STICKER"
        && request.resource.data.inputImagePath is string
        && request.resource.data.style is string
        && !( "errorCode" in request.resource.data )
        && !( "errorMessage" in request.resource.data )
        && !( "resultGenerationId" in request.resource.data );

      // klient NIE może aktualizować joba (status robi backend)
      allow update, delete: if false;
    }

    match /generations/{genId} {
      allow read: if signedIn() && resource.data.userId == request.auth.uid;
      // generacje tworzy backend, ale user może oznaczyć/odznaczyć ulubione
      allow create, delete: if false;
      allow update: if signedIn()
        && resource.data.userId == request.auth.uid
        && request.resource.data.diff(resource.data).changedKeys().hasOnly(["isFavorite"])
        && request.resource.data.isFavorite is bool;
    }
  }
}